// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // or "mysql" / "sqlite"
  url      = env("DATABASE_URL")
}

// ====================== USERS ======================
enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  RawMaterialTransfer RawMaterialTransfer[]
  ProductTransfer    ProductTransfer[]

  UserInventory UserInventory[]

  RawMaterialConsumption RawMaterialConsumption[]
}

// ====================== CUSTOMER ======================
model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  number    String    @unique
  address   String?
  invoices  Invoice[]
  shipping  ShippingInfo[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ====================== SHIPPING ======================
model ShippingInfo {
  id         Int       @id @default(autoincrement())
  name       String
  address    String
  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId Int?
  invoice    Invoice[]
}

// ====================== PRODUCT ======================
model Product {
  id        Int            @id @default(autoincrement())
  name      String
  size      String?
  price     Float
  category  String
  quantity  Int            @default(0) 
  items     InvoiceItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  ProductStructure ProductStructure[]
  ProductTransfer ProductTransfer[]

  RawMaterialConsumption RawMaterialConsumption[]
}

// ====================== INVOICE ======================
model Invoice {
  id            Int           @id @default(autoincrement())
  invoiceNumber String        @unique
  invoiceDate   DateTime
  dueDate       DateTime
  customer      Customer      @relation(fields: [customerId], references: [id])
  customerId    Int
  shipping      ShippingInfo? @relation(fields: [shippingId], references: [id])
  shippingId    Int?
  items         InvoiceItem[]
  subtotal      Float
  cgst          Float
  sgst          Float
  total         Float
  advancePaid   Float         @default(0)
  balanceDue    Float
  totalInWords  String
  deliveryDate  DateTime
  status        String        @default("DRAFT") // NEW
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}


// ====================== INVOICE ITEM ======================
model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   Int
  name        String
  quantity    Int
  price       Float
  total       Float
  notes       String?
  description String?
}


model RawMaterial {
  id        Int       @id @default(autoincrement())
  name      String
  quantity  Float     @default(0)
  unit      String?   @default("pcs")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  productStructures ProductStructure[]
  transfers        RawMaterialTransfer[]

  UserInventory UserInventory[]

  RawMaterialConsumption RawMaterialConsumption[]
}

model ProductStructure {
  id              Int          @id @default(autoincrement())
  product         Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       Int
  productName     String?      // Make optional first
  rawMaterial     RawMaterial  @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)
  rawMaterialId   Int
  materialName    String?      // Make optional first
  quantityRequired Float
  unit            String?      // Make optional first
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, rawMaterialId])
}

model RawMaterialTransfer {
  id             Int           @id @default(autoincrement())
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  rawMaterial    RawMaterial   @relation(fields: [rawMaterialId], references: [id])
  rawMaterialId  Int
  quantityIssued Float
  status         TransferStatus @default(SENT)
  notes          String?
  
  // New fields for partial rejection tracking
  quantityRejected Float?      @default(0)
  quantityApproved Float?      @default(0)
  rejectionReason  String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

enum TransferStatus {
  SENT
  USED
  RETURNED
  CANCELLED
  REPAIRING // Materials under repair
  FINISHED
}

enum ProductTransferStatus {
  SENT
  RECEIVED
  REJECTED
  CANCELLED
}

// Add this new model for Product Transfers
model ProductTransfer {
  id             Int                   @id @default(autoincrement())
  user           User                  @relation(fields: [userId], references: [id])
  userId         String
  product        Product               @relation(fields: [productId], references: [id])
  productId      Int
  quantitySent   Int
  status         ProductTransferStatus @default(SENT)
  notes          String?
  receivedBy     String?               // Super admin who received it
  receivedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model UserInventory {
  id            Int       @id @default(autoincrement())
  user          User      @relation(fields: [userId], references: [id])
  userId        String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])
  rawMaterialId Int
  quantity      Float     @default(0)
  unit          String    @default("pcs")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, rawMaterialId])
}

model RawMaterialConsumption {
  id                      Int       @id @default(autoincrement())
  userId                  String
  productId               Int
  rawMaterialId           Int
  quantityUsed            Float
  unit                    String
  productTransferQuantity Int       // Number of products transferred
  notes                   String?
  createdAt               DateTime  @default(now())
  
  // Relations
  user        User        @relation(fields: [userId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])
  rawMaterial RawMaterial @relation(fields: [rawMaterialId], references: [id])
  
  @@map("raw_material_consumption")
}

model Payment {
  id              String   @id @default(cuid())
  customerName    String
  customerNumber  String?
  customerEmail   String?
  amount          Float
  paymentMethod   PaymentMethod
  transactionId   String?
  receiptNumber   String   @unique
  status          PaymentStatus @default(DUE)
  dueDate         DateTime?
  balanceDue      Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("payments")
}

enum PaymentStatus {
  COMPLETED
  DUE
  OVERDUE
}

model ReceiptCounter {
  id        String @id @default(cuid())
  financialYear String @unique // Format: "2024-2025"
  lastNumber Int    @default(0)
  
  @@map("receipt_counters")
}

enum PaymentMethod {
  UPI
  CASH
  BANK_TRANSFER
  CARD
}